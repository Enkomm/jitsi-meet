defaults: &defaults
  working_directory: ~/repo

version: 2
jobs:
  build:
    <<: *defaults
    docker:
      - image: circleci/node:8.9

    steps:
      - checkout

      - run:
          name: Versions
          command: |
            npm --versions
            node -v
            git version

      - run:
          name: NPM install
          command: |
            npm install

      - run:
          name: Make
          command: |
            make

      - run:
          name: Clean
          command: |
            rm -rf node_modules

      - run:
          name: Install AWS cli
          command: |
            if [[ $CIRCLE_PULL_REQUESTS ]]; then exit 0; fi;

            sudo apt-get -y -qq update
            sudo apt-get -y -qq install python3.4-dev
            curl -O https://bootstrap.pypa.io/get-pip.py
            python3.4 get-pip.py --user
            export PATH=~/.local/bin:$PATH
            pip install awscli --upgrade --user

      - run:
          name: Publish
          command: |
            if [[ $CIRCLE_PULL_REQUESTS ]]; then exit 0; fi;

            export PATH=~/.local/bin:$PATH

            aws s3 cp . s3://src-jitsi.rocket.chat/ --recursive

workflows:
  version: 2
  build-and-test:
    jobs:
      - build:
          filters:
            branches:
              only: master
